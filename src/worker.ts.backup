import 'dotenv/config';
import { connectDB } from './core/db';
import { initializeGame, startGame, stopGame, getGameState } from './core/gameLoop';
import { io } from './socket';

const WORKER_PORT = parseInt(process.env.WORKER_PORT || '3001');

// Quáº£n lÃ½ cÃ¡c game Ä‘ang cháº¡y
const activeGameIds = new Set<string>();

/**
 * Worker cho game loop - cháº¡y trÃªn process riÃªng
 * Nháº­n lá»‡nh tá»« API server qua Redis/Message Queue hoáº·c HTTP
 */
const startWorker = async () => {
  try {
    await connectDB();
    
    console.log('ðŸŽ® Game Loop Worker started');
    console.log(`ðŸ“Š Monitoring games...`);

    // Láº¯ng nghe cÃ¡c lá»‡nh tá»« API server (cÃ³ thá»ƒ qua HTTP hoáº·c message queue)
    setupWorkerAPI();

    // Heartbeat Ä‘á»ƒ kiá»ƒm tra worker cÃ²n sá»‘ng
    setInterval(() => {
      console.log(`ðŸ’“ Worker heartbeat - Active games: ${activeGameIds.size}`);
    }, 30000);

  } catch (error) {
    console.error('Failed to start game loop worker:', error);
    process.exit(1);
  }
};

/**
 * Setup API Ä‘Æ¡n giáº£n Ä‘á»ƒ nháº­n lá»‡nh tá»« API server
 */
const setupWorkerAPI = () => {
  const express = require('express');
  const app = express();
  
  app.use(express.json());

  // Health check
  app.get('/health', (req: any, res: any) => {
    res.json({ 
      status: 'OK', 
      service: 'Game Loop Worker',
      activeGames: activeGameIds.size 
    });
  });

  // Láº¥y danh sÃ¡ch táº¥t cáº£ games
  app.get('/games', async (req: any, res: any) => {
    try {
      const { getAllGames } = require('./core/gameLoop');
      
      // Láº¥y táº¥t cáº£ games tá»« DB (getAllGames Ä‘Ã£ query DB)
      const games = await getAllGames();
      
      res.json({ 
        games, 
        total: games.length
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  // Khá»Ÿi táº¡o game má»›i
  app.post('/game/init', async (req: any, res: any) => {
    try {
      const { gameId, mapData, players } = req.body;
      
      if (!gameId || !mapData || !players) {
        return res.status(400).json({ error: 'Missing required fields' });
      }

      const { initializeGame } = require('./core/gameLoop');
      await initializeGame(gameId, mapData, players);
      activeGameIds.add(gameId);
      
      console.log(`ðŸŽ® Game ${gameId} initialized`);
      res.json({ success: true, gameId });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  // Báº¯t Ä‘áº§u game
  app.post('/game/:gameId/start', async (req: any, res: any) => {
    try {
      const { gameId } = req.params;
      
      const { startGame } = require('./core/gameLoop');
      await startGame(gameId);
      activeGameIds.add(gameId);
      
      console.log(`â–¶ï¸  Game ${gameId} started`);
      res.json({ success: true });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  // Dá»«ng game
  app.post('/game/:gameId/stop', async (req: any, res: any) => {
    try {
      const { gameId } = req.params;
      
      const { stopGame } = require('./core/gameLoop');
      await stopGame(gameId);
      activeGameIds.delete(gameId);
      
      console.log(`â¹ï¸  Game ${gameId} stopped`);
      res.json({ success: true });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  // Láº¥y tráº¡ng thÃ¡i game
  app.get('/game/:gameId/state', async (req: any, res: any) => {
    try {
      const { gameId } = req.params;
      const { getGameState } = require('./core/gameLoop');
      const gameState = await getGameState(gameId);
      
      if (!gameState) {
        return res.status(404).json({ error: 'Game not found' });
      }

      res.json({ gameState });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  app.listen(WORKER_PORT, () => {
    console.log(`ðŸ”§ Worker API listening on port ${WORKER_PORT}`);
  });
};

startWorker();

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received, shutting down worker...');
  
  // Dá»«ng táº¥t cáº£ game Ä‘ang cháº¡y
  activeGameIds.forEach(gameId => {
    stopGame(gameId);
  });
  
  console.log('Worker shutdown complete');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('SIGINT received, shutting down worker...');
  
  activeGameIds.forEach(gameId => {
    stopGame(gameId);
  });
  
  process.exit(0);
});
